{% extends "base.html" %}

{% block title %}WhatsApp Evolution API - Bot Cliente Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-whatsapp text-success"></i>
            WhatsApp Evolution API
        </h1>
    </div>
</div>

<!-- Evolution API Info Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success border-0" style="background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); color: white;">
            <div class="d-flex align-items-center">
                <i class="bi bi-rocket-takeoff fs-3 me-3"></i>
                <div>
                    <h5 class="mb-1">üöÄ EVOLUTION API INTEGRADA</h5>
                    <p class="mb-2">Sistema configurado para usar Evolution API - uma das melhores APIs para WhatsApp do mercado!</p>
                    <small><strong>Recursos:</strong> QR Code real, envio de mensagens, webhooks, alta performance</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> Configura√ß√£o da Evolution API</h5>
            </div>
            <div class="card-body">
                <form id="apiConfigForm" method="POST" action="{{ url_for('configure_evolution_api') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="api_url" class="form-label">URL da API *</label>
                            <input type="url" class="form-control" id="api_url" name="api_url" 
                                   placeholder="http://localhost:8080" required>
                            <div class="form-text">URL onde sua Evolution API est√° rodando</div>
                        </div>
                        <div class="col-md-4">
                            <label for="api_key" class="form-label">API Key (Opcional)</label>
                            <input type="text" class="form-control" id="api_key" name="api_key" 
                                   placeholder="sua-api-key-aqui">
                            <div class="form-text">Token de autentica√ß√£o (se configurado)</div>
                        </div>
                        <div class="col-md-4">
                            <label for="instance_name" class="form-label">Nome da Inst√¢ncia *</label>
                            <input type="text" class="form-control" id="instance_name" name="instance_name" 
                                   value="clientmanager" placeholder="clientmanager" required>
                            <div class="form-text">Nome √∫nico para esta inst√¢ncia</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i>
                            Salvar Configura√ß√£o
                        </button>
                        <button type="button" class="btn btn-outline-info ms-2" onclick="testConnection()">
                            <i class="bi bi-wifi"></i>
                            Testar Conex√£o
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>Status da Conex√£o</h5>
                        {% if connected %}
                            <span class="badge bg-success fs-6">
                                <i class="bi bi-check-circle"></i>
                                Conectado
                            </span>
                            <p class="text-muted mt-2">WhatsApp conectado via Evolution API e pronto para enviar mensagens.</p>
                        {% else %}
                            <span class="badge bg-warning fs-6">
                                <i class="bi bi-qr-code"></i>
                                Aguardando QR Code
                            </span>
                            <p class="text-muted mt-2">Configure a API acima e gere o QR Code para conectar.</p>
                        {% endif %}
                    </div>
                    <div>
                        {% if connected %}
                            <form method="POST" action="{{ url_for('whatsapp_disconnect') }}" style="display: inline;">
                                <button type="submit" class="btn btn-outline-danger">
                                    <i class="bi bi-power"></i>
                                    Desconectar
                                </button>
                            </form>
                        {% else %}
                            <button onclick="generateQRCode()" class="btn btn-success" id="generateQRBtn">
                                <i class="bi bi-qr-code"></i>
                                Gerar QR Code
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Section -->
<div class="row mb-4" id="qrCodeSection" style="display: none;">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header text-center bg-success text-white">
                <h5><i class="bi bi-qr-code"></i> QR Code - Evolution API</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3" id="qrCodeContainer">
                    <!-- QR code will be inserted here -->
                </div>
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Como Conectar:</h6>
                    <ol class="text-start">
                        <li>Abra o WhatsApp no seu celular</li>
                        <li>V√° em <strong>Menu (‚ãÆ) > Dispositivos conectados</strong></li>
                        <li>Toque em <strong>Conectar um dispositivo</strong></li>
                        <li>Aponte a c√¢mera para este QR Code</li>
                        <li>Aguarde a confirma√ß√£o de conex√£o</li>
                    </ol>
                </div>
                <div class="d-flex gap-2 justify-content-center">
                    <button onclick="refreshQRCode()" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-clockwise"></i>
                        Atualizar QR Code
                    </button>
                    <button onclick="checkConnection()" class="btn btn-outline-success">
                        <i class="bi bi-wifi"></i>
                        Verificar Conex√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Evolution API Installation Guide -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-download"></i> Guia de Instala√ß√£o Evolution API</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="installationAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#docker">
                                üê≥ Instala√ß√£o com Docker (Recomendado)
                            </button>
                        </h2>
                        <div id="docker" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <h6>1. Crie um arquivo docker-compose.yml:</h6>
                                <pre><code>version: '3.8'
services:
  evolution-api:
    image: davidsongomes/evolution-api:latest
    container_name: evolution_api
    ports:
      - "8080:8080"
    environment:
      - SERVER_TYPE=http
      - CORS_ORIGIN=*
      - DEL_INSTANCE=false
      - DEL_TEMP_INSTANCES=true
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    restart: unless-stopped

volumes:
  evolution_instances:
  evolution_store:</code></pre>
                                
                                <h6 class="mt-3">2. Execute os comandos:</h6>
                                <pre><code># Inicie a API
docker-compose up -d

# Verifique se est√° rodando
docker ps</code></pre>
                                
                                <div class="alert alert-success mt-3">
                                    <strong>Pronto!</strong> Sua Evolution API estar√° rodando em <code>http://localhost:8080</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#manual">
                                ‚öôÔ∏è Instala√ß√£o Manual
                            </button>
                        </h2>
                        <div id="manual" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <h6>1. Clone o reposit√≥rio:</h6>
                                <pre><code>git clone https://github.com/EvolutionAPI/evolution-api.git
cd evolution-api</code></pre>
                                
                                <h6>2. Instale as depend√™ncias:</h6>
                                <pre><code>npm install</code></pre>
                                
                                <h6>3. Configure o arquivo .env:</h6>
                                <pre><code>cp .env.example .env</code></pre>
                                
                                <h6>4. Inicie a API:</h6>
                                <pre><code>npm run start:prod</code></pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cloud">
                                ‚òÅÔ∏è Evolution API na Nuvem
                            </button>
                        </h2>
                        <div id="cloud" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p>Voc√™ pode usar servi√ßos que oferecem Evolution API hospedada:</p>
                                <ul>
                                    <li><strong>Railway:</strong> Deploy com um clique</li>
                                    <li><strong>Heroku:</strong> Hospedagem gratuita (com limita√ß√µes)</li>
                                    <li><strong>DigitalOcean:</strong> VPS com Docker</li>
                                    <li><strong>AWS/Google Cloud:</strong> Inst√¢ncias na nuvem</li>
                                </ul>
                                
                                <div class="alert alert-info">
                                    <strong>Dica:</strong> Para produ√ß√£o, recomendamos usar um servidor VPS com pelo menos 1GB RAM.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Status Info -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> Recursos da Evolution API</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>‚úÖ Recursos Inclusos:</h6>
                        <ul>
                            <li>QR Code real para conex√£o</li>
                            <li>Envio de mensagens de texto</li>
                            <li>Envio de imagens e documentos</li>
                            <li>Webhooks para receber mensagens</li>
                            <li>Grupos e listas de transmiss√£o</li>
                            <li>Status de entrega das mensagens</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>üîß Configura√ß√µes Recomendadas:</h6>
                        <ul>
                            <li>Use HTTPS em produ√ß√£o</li>
                            <li>Configure um webhook endpoint</li>
                            <li>Ative logs para debug</li>
                            <li>Configure rate limiting</li>
                            <li>Use inst√¢ncias separadas por cliente</li>
                            <li>Monitore o status da API</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-success mt-3">
                    <h6><i class="bi bi-check-circle"></i> Vantagens da Evolution API:</h6>
                    <p class="mb-0">
                        <strong>‚úÖ Gratuita e Open Source</strong> ‚Ä¢ 
                        <strong>‚úÖ F√°cil de configurar</strong> ‚Ä¢ 
                        <strong>‚úÖ Comunidade ativa</strong> ‚Ä¢ 
                        <strong>‚úÖ Documenta√ß√£o completa</strong> ‚Ä¢ 
                        <strong>‚úÖ Suporte a multi-inst√¢ncias</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Message Section -->
{% if connected %}
<div class="row mt-4">
    <div class="col-md-8 mx-auto">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-send"></i> Testar Envio de Mensagem</h5>
            </div>
            <div class="card-body">
                <form id="testMessageForm">
                    <div class="mb-3">
                        <label for="testPhone" class="form-label">N√∫mero de Teste</label>
                        <input type="tel" class="form-control" id="testPhone" 
                               placeholder="Ex: 5511999999999" required>
                        <div class="form-text">Formato: c√≥digo do pa√≠s + DDD + n√∫mero (sem espa√ßos)</div>
                    </div>
                    <div class="mb-3">
                        <label for="testMessage" class="form-label">Mensagem de Teste</label>
                        <textarea class="form-control" id="testMessage" rows="3" 
                                  placeholder="Digite uma mensagem de teste..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send"></i>
                        Enviar via Evolution API
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Configuration form
    document.getElementById('apiConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const apiUrl = document.getElementById('api_url').value;
        const apiKey = document.getElementById('api_key').value;
        const instanceName = document.getElementById('instance_name').value;
        
        // Save configuration (you'd implement the backend route)
        fetch('/api/whatsapp/configure', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                api_url: apiUrl,
                api_key: apiKey,
                instance_name: instanceName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Configura√ß√£o Salva!',
                    text: 'Evolution API configurada com sucesso',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } else {
                Swal.fire({
                    title: 'Erro',
                    text: data.error || 'Erro ao salvar configura√ß√£o',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Erro',
                text: 'Erro de conex√£o',
                icon: 'error'
            });
        });
    });

    // Generate QR Code
    function generateQRCode() {
        const btn = document.getElementById('generateQRBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Gerando...';
        
        fetch('/api/whatsapp/qrcode', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success && data.qr_code) {
                document.getElementById('qrCodeContainer').innerHTML = 
                    `<img src="${data.qr_code}" alt="QR Code" class="img-fluid" style="max-width: 350px; border: 3px solid #28a745; border-radius: 10px;">`;
                document.getElementById('qrCodeSection').style.display = 'block';
                
                // Auto-check connection every 3 seconds
                const connectionChecker = setInterval(() => {
                    checkConnection(true).then(connected => {
                        if (connected) {
                            clearInterval(connectionChecker);
                            window.location.reload();
                        }
                    });
                }, 3000);
                
            } else {
                Swal.fire({
                    title: 'Erro',
                    text: data.error || 'Erro ao gerar QR code',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Erro',
                text: 'Erro de conex√£o com a API',
                icon: 'error'
            });
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-qr-code"></i> Gerar QR Code';
        });
    }

    // Refresh QR Code
    function refreshQRCode() {
        generateQRCode();
    }

    // Check connection
    function checkConnection(silent = false) {
        return fetch('/api/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            if (!silent) {
                if (data.connected) {
                    Swal.fire({
                        title: 'Conectado!',
                        text: 'WhatsApp conectado via Evolution API',
                        icon: 'success',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'N√£o Conectado',
                        text: data.error || 'WhatsApp n√£o est√° conectado',
                        icon: 'warning'
                    });
                }
            }
            return data.connected;
        })
        .catch(error => {
            if (!silent) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Erro',
                    text: 'Erro ao verificar conex√£o',
                    icon: 'error'
                });
            }
            return false;
        });
    }

    // Test connection
    function testConnection() {
        const apiUrl = document.getElementById('api_url').value;
        if (!apiUrl) {
            Swal.fire({
                title: 'URL Necess√°ria',
                text: 'Digite a URL da Evolution API primeiro',
                icon: 'warning'
            });
            return;
        }
        
        Swal.fire({
            title: 'Testando...',
            text: 'Verificando conex√£o com Evolution API',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch('/api/whatsapp/test-connection', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({api_url: apiUrl})
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            if (data.success) {
                Swal.fire({
                    title: 'Conex√£o OK!',
                    text: 'Evolution API est√° respondendo corretamente',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
            } else {
                Swal.fire({
                    title: 'Erro de Conex√£o',
                    text: data.error || 'N√£o foi poss√≠vel conectar √† Evolution API',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Error:', error);
            Swal.fire({
                title: 'Erro',
                text: 'Erro ao testar conex√£o',
                icon: 'error'
            });
        });
    }

    // Test message form
    {% if connected %}
    document.getElementById('testMessageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const phone = document.getElementById('testPhone').value;
        const message = document.getElementById('testMessage').value;
        
        // Send test message
        fetch('/api/whatsapp/send-test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: phone, message: message})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Mensagem Enviada!',
                    text: `Mensagem enviada para ${phone} via Evolution API`,
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });
                this.reset();
            } else {
                Swal.fire({
                    title: 'Erro no Envio',
                    text: data.error || 'Erro ao enviar mensagem',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Erro',
                text: 'Erro de conex√£o',
                icon: 'error'
            });
        });
    });
    {% endif %}

    // Auto-refresh status every 30 seconds
    setInterval(() => {
        if (!{{ connected|tojson }}) {
            checkConnection(true);
        }
    }, 30000);

    // Load current configuration on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Animate cards
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
        
        // Load saved configuration
        fetch('/api/whatsapp/config')
        .then(response => response.json())
        .then(data => {
            if (data.api_url) document.getElementById('api_url').value = data.api_url;
            if (data.api_key) document.getElementById('api_key').value = data.api_key;
            if (data.instance_name) document.getElementById('instance_name').value = data.instance_name;
        })
        .catch(error => console.log('No saved config found'));
    });
</script>
{% endblock %}
