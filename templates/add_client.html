{% extends "base.html" %}

{% block title %}Adicionar Cliente - Bot Cliente Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="animate-slideInUp">
                <i class="bi bi-person-plus text-gradient"></i>
                Adicionar Cliente
            </h1>
            <a href="{{ url_for('clients') }}" class="btn btn-secondary hover-lift">
                <i class="bi bi-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 col-md-10 mx-auto">
        <div class="card glass animate-slideInUp">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person-plus-fill"></i>
                    Informa√ß√µes do Cliente
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="addClientForm">
                    <!-- Basic Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-gradient mb-3">
                                <i class="bi bi-person-circle"></i>
                                Informa√ß√µes B√°sicas
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Nome do Cliente *</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="Digite o nome completo">
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">N√∫mero do WhatsApp *</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   placeholder="Ex: 5511999999999" required>
                            <div class="form-text">Formato: c√≥digo do pa√≠s + DDD + n√∫mero</div>
                        </div>
                    </div>

                    <!-- Plan Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-gradient mb-3">
                                <i class="bi bi-gear-fill"></i>
                                Detalhes do Plano
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="plan_type" class="form-label">Categoria do Plano *</label>
                            <select class="form-select" id="plan_type" name="plan_type" required onchange="updatePlanDetails()">
                                <option value="">Selecione a categoria</option>
                                <option value="IPTV">üì∫ IPTV - TV por Internet</option>
                                <option value="VPN">üîí VPN - Rede Privada Virtual</option>
                                <option value="STREAMING">üé¨ Streaming - Plataformas de V√≠deo</option>
                                <option value="GAMING">üéÆ Gaming - Servi√ßos para Jogos</option>
                                <option value="INTERNET">üåê Internet - Conex√£o Banda Larga</option>
                                <option value="OUTROS">‚öôÔ∏è Outros Servi√ßos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="value" class="form-label">Valor do Plano (R$) *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="value" name="value" 
                                       step="0.01" min="0" required placeholder="0,00">
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-gradient mb-3">
                                <i class="bi bi-calendar-check"></i>
                                Informa√ß√µes de Pagamento
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="plan_duration" class="form-label">Data de Vencimento do Plano *</label>
                            <input type="date" class="form-control" id="plan_duration" name="plan_duration" required>
                            <div class="form-text">Data em que o plano expira</div>
                        </div>
                        <div class="col-md-6">
                            <label for="payment_status" class="form-label">Status do Pagamento</label>
                            <select class="form-select" id="payment_status" name="payment_status">
                                <option value="pending">‚è≥ Pendente</option>
                                <option value="paid">‚úÖ Pago</option>
                                <option value="overdue">‚ùå Em Atraso</option>
                            </select>
                        </div>
                    </div>

                    <!-- Reminder Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-gradient mb-3">
                                <i class="bi bi-clock-fill"></i>
                                Configura√ß√£o de Lembretes
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="reminder_time_3days" class="form-label">Hor√°rio Lembrete 3 Dias</label>
                            <input type="time" class="form-control" id="reminder_time_3days" 
                                   name="reminder_time_3days" value="09:00">
                            <div class="form-text">Hor√°rio para enviar lembrete 3 dias antes</div>
                        </div>
                        <div class="col-md-6">
                            <label for="reminder_time_payment" class="form-label">Hor√°rio Lembrete Pagamento</label>
                            <input type="time" class="form-control" id="reminder_time_payment" 
                                   name="reminder_time_payment" value="10:00">
                            <div class="form-text">Hor√°rio para enviar lembrete no dia do vencimento</div>
                        </div>
                    </div>

                    <!-- Custom Messages -->
                    <div class="mb-4">
                        <h6 class="text-gradient mb-3">
                            <i class="bi bi-chat-dots-fill"></i>
                            Mensagens Personalizadas (Opcional)
                        </h6>
                        <div class="alert alert-info glass">
                            <i class="bi bi-robot"></i>
                            <strong>IA Integrada:</strong> Se deixar em branco, nossa IA gerar√° mensagens personalizadas e inteligentes automaticamente baseadas na categoria do plano!
                        </div>
                        <div class="text-muted mb-3">
                            <strong>Vari√°veis dispon√≠veis:</strong> 
                            <code>{name}</code>, <code>{plan_type}</code>, <code>{value}</code>, <code>{payment_day}</code>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="custom_message_3days" class="form-label">Mensagem - 3 Dias Antes</label>
                            <textarea class="form-control" id="custom_message_3days" name="custom_message_3days" 
                                      rows="3" placeholder="Deixe em branco para usar IA ou digite sua mensagem personalizada..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="custom_message_payment" class="form-label">Mensagem - Dia do Vencimento</label>
                            <textarea class="form-control" id="custom_message_payment" name="custom_message_payment" 
                                      rows="3" placeholder="Deixe em branco para usar IA ou digite sua mensagem personalizada..."></textarea>
                        </div>
                    </div>

                    <!-- Plan Preview -->
                    <div class="card mb-4" id="planPreview" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-eye"></i>
                                Pr√©via das Mensagens
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Lembrete 3 Dias:</h6>
                                    <div class="bg-light p-3 rounded text-dark" id="preview3days"></div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Dia do Pagamento:</h6>
                                    <div class="bg-light p-3 rounded text-dark" id="previewPayment"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('clients') }}" class="btn btn-secondary me-md-2 hover-lift">
                            <i class="bi bi-x-circle"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary hover-lift">
                            <i class="bi bi-save"></i>
                            Salvar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Plan type specific messages
    const planMessages = {
        'IPTV': {
            '3days': 'üì∫ Ol√° {name}! Seu plano IPTV Premium de R$ {value} vence em 3 dias (dia {payment_day}). Mantenha seus canais favoritos sempre dispon√≠veis! Renove j√° e continue aproveitando todos os canais em HD.',
            'payment': 'üì∫ {name}, hoje √© o dia! Seu plano IPTV de R$ {value} vence hoje. Para n√£o perder nenhum programa, renove agora e garanta mais 30 dias de entretenimento sem interrup√ß√£o!'
        },
        'VPN': {
            '3days': 'üîí Ol√° {name}! Sua prote√ß√£o VPN Premium de R$ {value} vence em 3 dias (dia {payment_day}). Mantenha sua privacidade e seguran√ßa online protegidas. Renove j√°!',
            'payment': 'üîí {name}, sua seguran√ßa √© prioridade! Seu plano VPN de R$ {value} vence hoje. Renove agora e continue navegando com total privacidade e prote√ß√£o contra amea√ßas online.'
        },
        'STREAMING': {
            '3days': 'üé¨ Ol√° {name}! Seu plano de Streaming de R$ {value} vence em 3 dias (dia {payment_day}). Continue assistindo seus filmes e s√©ries favoritos sem interrup√ß√£o!',
            'payment': 'üé¨ {name}, n√£o perca seus shows favoritos! Seu plano de Streaming de R$ {value} vence hoje. Renove agora e mantenha acesso a todo o cat√°logo!'
        },
        'GAMING': {
            '3days': 'üéÆ Ol√° {name}! Seu plano Gaming de R$ {value} vence em 3 dias (dia {payment_day}). Mantenha sua experi√™ncia de jogo sempre no m√°ximo desempenho!',
            'payment': 'üéÆ {name}, game over no plano! Seu servi√ßo Gaming de R$ {value} vence hoje. Renove agora e continue dominando seus jogos favoritos!'
        },
        'INTERNET': {
            '3days': 'üåê Ol√° {name}! Seu plano de Internet de R$ {value} vence em 3 dias (dia {payment_day}). Mantenha sua conex√£o sempre est√°vel e r√°pida!',
            'payment': 'üåê {name}, sua conex√£o est√° prestes a ser interrompida! Seu plano de Internet de R$ {value} vence hoje. Renove agora!'
        },
        'OUTROS': {
            '3days': 'Ol√° {name}! Seu plano de R$ {value} vence em 3 dias (dia {payment_day}). N√£o esque√ßa de renovar para manter o servi√ßo ativo!',
            'payment': '{name}, seu plano de R$ {value} vence hoje. Renove agora para continuar aproveitando nossos servi√ßos!'
        }
    };

    function updatePlanDetails() {
        const planType = document.getElementById('plan_type').value;
        const preview = document.getElementById('planPreview');
        
        if (planType && planMessages[planType]) {
            const name = document.getElementById('name').value || '{name}';
            const value = document.getElementById('value').value || '{value}';
            const planDuration = document.getElementById('plan_duration').value;
            
            let paymentDay = '{payment_day}';
            if (planDuration) {
                const date = new Date(planDuration);
                paymentDay = date.getDate();
            }
            
            const preview3days = planMessages[planType]['3days']
                .replace('{name}', name)
                .replace('{value}', value)
                .replace('{payment_day}', paymentDay);
                
            const previewPayment = planMessages[planType]['payment']
                .replace('{name}', name)
                .replace('{value}', value)
                .replace('{payment_day}', paymentDay);
            
            document.getElementById('preview3days').textContent = preview3days;
            document.getElementById('previewPayment').textContent = previewPayment;
            
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    // Update preview when inputs change
    document.getElementById('name').addEventListener('input', updatePlanDetails);
    document.getElementById('value').addEventListener('input', updatePlanDetails);
    document.getElementById('plan_duration').addEventListener('change', updatePlanDetails);

    // Set default date to next month
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
        document.getElementById('plan_duration').value = nextMonth.toISOString().split('T')[0];
    });

    // Form validation
    document.getElementById('addClientForm').addEventListener('submit', function(e) {
        const phone = document.getElementById('phone').value;
        const phoneRegex = /^55\d{10,11}$/;
        
        if (!phoneRegex.test(phone)) {
            e.preventDefault();
            alert('Por favor, insira um n√∫mero de WhatsApp v√°lido no formato: 5511999999999');
            return false;
        }
    });
</script>
{% endblock %}
